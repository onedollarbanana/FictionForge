{
  "type": "file",
  "name": "page.tsx",
  "path": "src/app/story/[id]/page.tsx",
  "size": 17648,
  "sha": "78211e4fd866b3858e54090f23e38d640d132462",
  "content": "import { createClient } from \"@/lib/supabase/server\";\nimport { notFound } from \"next/navigation\";\nimport Link from \"next/link\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { BookOpen, Check, Clock, Eye, Heart, Lock, Pencil, User } from \"lucide-react\";\nimport { formatDistanceToNow } from \"date-fns\";\nimport { LibraryButton } from \"@/components/story/LibraryButton\";\nimport { AnnouncementBanner } from \"@/components/announcements\";\nimport { StoryRatingSection } from \"@/components/story/story-rating-section\";\nimport { Breadcrumb } from \"@/components/ui/breadcrumb\";\nimport { RelatedStories } from \"@/components/story/related-stories\";\nimport { MoreFromAuthor } from \"@/components/story/more-from-author\";\nimport { ReportButton } from \"@/components/moderation/report-button\";\nimport { hasMatureContent } from \"@/lib/content-warnings\";\nimport { ContentWarningGate } from \"@/components/story/content-warning-gate\";\nimport { NominateButton } from \"@/components/story/nominate-button\";\nimport { CommunityPickBadge } from \"@/components/story/community-pick-badge\";\nimport { getCommunityPickBadge } from \"@/lib/community-picks\";\nimport { AuthorTierCards } from \"@/components/story/author-tier-cards\";\nimport { type TierName } from \"@/lib/platform-config\";\nimport { ShareButtons } from \"@/components/ui/share-buttons\";\nimport type { Metadata } from \"next\";\n\nexport const revalidate = 120\n\ninterface PageProps {\n  params: { id: string };\n}\n\nexport async function generateMetadata({ params }: PageProps): Promise<Metadata> {\n  const { id } = params;\n  const supabase = await createClient();\n\n  const { data: story } = await supabase\n    .from(\"stories\")\n    .select(`\n      title,\n      blurb,\n      cover_url,\n      genres,\n      profiles!author_id(\n        username,\n        display_name\n      )\n    `)\n    .eq(\"id\", id)\n    .single();\n\n  if (!story) {\n    return { title: \"Story Not Found | Fictionry\" };\n  }\n\n  const authorName = (story.profiles as any)?.display_name || (story.profiles as any)?.username || \"Unknown\";\n  const title = `${story.title} by ${authorName} | Fictionry`;\n  const description = story.blurb\n    ? story.blurb.length > 160\n      ? story.blurb.substring(0, 157) + \"...\"\n      : story.blurb\n    : `Read ${story.title} by ${authorName} on Fictionry`;\n\n  const ogParams = new URLSearchParams();\n  ogParams.set(\"title\", story.title);\n  ogParams.set(\"author\", authorName);\n  if (story.cover_url) ogParams.set(\"cover\", story.cover_url);\n  if (story.blurb) ogParams.set(\"description\", story.blurb.substring(0, 120));\n  if (story.genres && story.genres.length > 0) ogParams.set(\"genre\", story.genres[0]);\n\n  const ogImageUrl = `/api/og?${ogParams.toString()}`;\n\n  return {\n    title,\n    description,\n    openGraph: {\n      title,\n      description,\n      type: \"article\",\n      images: [{ url: ogImageUrl, width: 1200, height: 630 }],\n    },\n    twitter: {\n      card: \"summary_large_image\",\n      title,\n      description,\n      images: [ogImageUrl],\n    },\n  };\n}\n\nexport default async function StoryPage({ params }: PageProps) {\n  const { id } = params;\n  const supabase = await createClient();\n\n  // Fetch story with author info\n  const { data: story, error } = await supabase\n    .from(\"stories\")\n    .select(`\n      *,\n      profiles!author_id(\n        username,\n        display_name,\n        avatar_url\n      )\n    `)\n    .eq(\"id\", id)\n    .single();\n\n  if (error || !story) {\n    notFound();\n  }\n\n  // Get current user to check ownership\n  const { data: { user } } = await supabase.auth.getUser();\n  const isOwner = user && story.author_id === user.id;\n\n  // Check visibility - only owner can see draft/removed stories\n  if ((story.visibility === 'draft' || story.visibility === 'removed') && !isOwner) {\n    notFound();\n  }\n\n  // Fetch published chapters (include min_tier_name for lock icons)\n  const { data: chapters } = await supabase\n    .from(\"chapters\")\n    .select(\"id, title, chapter_number, word_count, likes, created_at, is_published, min_tier_name\")\n    .eq(\"story_id\", id)\n    .eq(\"is_published\", true)\n    .order(\"chapter_number\", { ascending: true });\n\n  const publishedChapters = chapters || [];\n  const totalWords = publishedChapters.reduce((sum, ch) => sum + (ch.word_count || 0), 0);\n\n  // Fetch author tiers\n  const { data: authorTiers } = await supabase\n    .from('author_tiers')\n    .select('tier_name, enabled, description, advance_chapter_count')\n    .eq('author_id', story.author_id)\n    .eq('enabled', true)\n    .order('tier_name');\n\n  // Check user's subscription to this author\n  let userSubscription = null;\n  if (user) {\n    const { data: sub } = await supabase\n      .from('author_subscriptions')\n      .select('tier_name, status')\n      .eq('subscriber_id', user.id)\n      .eq('author_id', story.author_id)\n      .eq('status', 'active')\n      .single();\n    userSubscription = sub;\n  }\n\n  // Fetch announcements for this story (last 30 days)\n  const thirtyDaysAgo = new Date();\n  thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);\n  \n  const { data: allAnnouncements } = await supabase\n    .from(\"announcements\")\n    .select(\"*\")\n    .eq(\"story_id\", id)\n    .gte(\"created_at\", thirtyDaysAgo.toISOString())\n    .order(\"created_at\", { ascending: false })\n    .limit(10);\n\n  // Get which announcements user has read\n  let unreadAnnouncements = allAnnouncements || [];\n  \n  if (user && allAnnouncements && allAnnouncements.length > 0) {\n    const announcementIds = allAnnouncements.map(a => a.id);\n    const { data: reads } = await supabase\n      .from(\"announcement_reads\")\n      .select(\"announcement_id\")\n      .eq(\"user_id\", user.id)\n      .in(\"announcement_id\", announcementIds);\n    \n    const readIds = new Set((reads || []).map(r => r.announcement_id));\n    unreadAnnouncements = allAnnouncements.filter(a => !readIds.has(a.id));\n  }\n\n  // Get which chapters user has read\n  let readChapterIds = new Set<string>();\n  \n  if (user && publishedChapters.length > 0) {\n    const chapterIds = publishedChapters.map(c => c.id);\n    const { data: chapterReads } = await supabase\n      .from(\"chapter_reads\")\n      .select(\"chapter_id\")\n      .eq(\"user_id\", user.id)\n      .in(\"chapter_id\", chapterIds);\n    \n    readChapterIds = new Set((chapterReads || []).map(r => r.chapter_id));\n  }\n\n  // Check if this story is a Community Pick\n  const communityPickData = await getCommunityPickBadge(id, supabase);\n\n  const authorName = story.profiles?.display_name || story.profiles?.username || 'Unknown';\n  const isMature = hasMatureContent(story.content_warnings || []);\n\n  const pageContent = (\n    <div className=\"container mx-auto px-4 py-8 max-w-4xl\">\n      {/* Breadcrumb */}\n      <Breadcrumb items={[\n        { label: 'Browse', href: '/browse' },\n        { label: story.title }\n      ]} />\n\n      {/* Story Header */}\n      <div className=\"flex flex-col md:flex-row gap-6 mb-8\">\n        {/* Cover Image - 2:3 aspect ratio */}\n        {story.cover_url ? (\n          <div className=\"relative w-full md:w-48 aspect-[2/3] rounded-lg overflow-hidden shrink-0\">\n            <CommunityPickBadge pickMonth={communityPickData?.pickMonth} />\n            <img\n              src={`${story.cover_url}?t=${new Date(story.updated_at).getTime()}`}\n              alt={`Cover for ${story.title}`}\n              className=\"w-full h-full object-cover\"\n            />\n          </div>\n        ) : (\n          <div className=\"relative w-full md:w-48 aspect-[2/3] bg-gradient-to-br from-primary/20 to-primary/5 rounded-lg flex items-center justify-center shrink-0\">\n            <CommunityPickBadge pickMonth={communityPickData?.pickMonth} />\n            <BookOpen className=\"h-16 w-16 text-primary/40\" />\n          </div>\n        )}\n\n        <div className=\"flex-1\">\n          <div className=\"flex items-start justify-between gap-2 mb-2\">\n            <h1 className=\"text-3xl font-bold\">{story.title}</h1>\n            {isOwner && (\n              <Button variant=\"outline\" size=\"sm\" asChild className=\"shrink-0\">\n                <Link href={`/author/stories/${id}/edit`}>\n                  <Pencil className=\"h-4 w-4 mr-1\" />\n                  Edit\n                </Link>\n              </Button>\n            )}\n          </div>\n          \n          <Link \n            href={`/author/${story.profiles?.username}`}\n            className=\"text-muted-foreground hover:text-primary flex items-center gap-2 mb-4\"\n          >\n            <User className=\"h-4 w-4\" />\n            {authorName}\n          </Link>\n\n          {/* Stats Row */}\n          <div className=\"flex flex-wrap gap-4 text-sm text-muted-foreground mb-4\">\n            <span className=\"flex items-center gap-1\">\n              <BookOpen className=\"h-4 w-4\" />\n              {publishedChapters.length} chapters\n            </span>\n            <span className=\"flex items-center gap-1\">\n              <Clock className=\"h-4 w-4\" />\n              {totalWords.toLocaleString()} words\n            </span>\n            <span className=\"flex items-center gap-1\">\n              <Eye className=\"h-4 w-4\" />\n              {(story.total_views ?? 0).toLocaleString()} views\n            </span>\n            <span className=\"flex items-center gap-1\">\n              <Heart className=\"h-4 w-4\" />\n              {(story.follower_count ?? 0).toLocaleString()} followers\n            </span>\n          </div>\n\n          {/* Status Badge */}\n          <Badge variant=\"secondary\" className=\"mb-4\">\n            {story.status?.charAt(0).toUpperCase() + story.status?.slice(1) || \"Ongoing\"}\n          </Badge>\n\n          {story.release_schedule && (\n            <span className=\"text-sm text-muted-foreground flex items-center gap-1\">\n              ðŸ“… {story.release_schedule}\n            </span>\n          )}\n\n          {/* Genres - now clickable */}\n          {story.genres && story.genres.length > 0 && (\n            <div className=\"flex flex-wrap items-center gap-2 mb-3\">\n              {(story.genres || []).map((genre: string) => (\n                <Link key={genre} href={`/browse/genre/${encodeURIComponent(genre)}`}>\n                  <Badge variant=\"default\" className=\"cursor-pointer hover:bg-primary/80\">\n                    {genre}\n                  </Badge>\n                </Link>\n              ))}\n            </div>\n          )}\n          \n          {/* Tags - now clickable */}\n          {story.tags && story.tags.length > 0 && (\n            <div className=\"flex flex-wrap items-center gap-2 mb-4\">\n              <span className=\"text-sm text-muted-foreground\">Tags:</span>\n              {(story.tags || []).map((tag: string) => (\n                <Link key={tag} href={`/browse/tag/${encodeURIComponent(tag)}`}>\n                  <Badge variant=\"secondary\" className=\"cursor-pointer hover:bg-muted\">\n                    {tag}\n                  </Badge>\n                </Link>\n              ))}\n            </div>\n          )}\n\n          {/* Content Warnings */}\n          {story.content_warnings && story.content_warnings.length > 0 && (\n            <div className=\"flex flex-wrap gap-1.5 mb-4\">\n              {story.content_warnings.map((warning: string) => (\n                <span key={warning} className=\"inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-300\">\n                  âš ï¸ {warning.replace(/_/g, ' ').replace(/\\b\\w/g, c => c.toUpperCase())}\n                </span>\n              ))}\n            </div>\n          )}\n\n          {/* Action Buttons */}\n          <div className=\"flex gap-3\">\n            {publishedChapters.length > 0 ? (\n              <Button asChild>\n                <Link href={`/story/${id}/chapter/${publishedChapters[0].id}`}>\n                  Start Reading\n                </Link>\n              </Button>\n            ) : (\n              <Button disabled>No Chapters Yet</Button>\n            )}\n            <LibraryButton \n              storyId={id} \n              initialFollowerCount={story.follower_count ?? 0} \n            />\n            <ShareButtons\n              url={`https://fictionry.com/story/${id}`}\n              title={`${story.title} by ${authorName}`}\n              description={story.blurb || undefined}\n            />\n          </div>\n          {/* Report Button - only for logged-in non-owners */}\n          {user && !isOwner && (\n            <div className=\"mt-2 flex items-center gap-2\">\n              <ReportButton\n                contentType=\"story\"\n                contentId={id}\n                contentTitle={story.title}\n                size=\"sm\"\n                variant=\"ghost\"\n              />\n              {story.visibility === 'published' && (\n                <NominateButton storyId={id} storyWordCount={totalWords} />\n              )}\n            </div>\n          )}\n        </div>\n      </div>\n\n      {/* Announcements Banner */}\n      {(allAnnouncements && allAnnouncements.length > 0) && (\n        <AnnouncementBanner \n          announcements={allAnnouncements}\n          unreadIds={unreadAnnouncements.map(a => a.id)}\n          userId={user?.id || null}\n        />\n      )}\n\n      {/* Description */}\n      <Card className=\"mb-6\">\n        <CardContent className=\"pt-6 overflow-hidden\">\n          <h2 className=\"text-lg font-semibold mb-3\">Description</h2>\n          <p className=\"text-muted-foreground whitespace-pre-wrap break-words\">\n            {story.blurb || \"No description provided.\"}\n          </p>\n        </CardContent>\n      </Card>\n\n      {/* Author Tier Cards */}\n      {authorTiers && authorTiers.length > 0 && (\n        <div className=\"mb-6\">\n          <AuthorTierCards\n            authorId={story.author_id}\n            authorName={authorName}\n            tiers={authorTiers.map(t => ({\n              tier_name: t.tier_name as TierName,\n              description: t.description,\n              advance_chapter_count: t.advance_chapter_count,\n            }))}\n            currentSubscription={userSubscription ? {\n              tier_name: userSubscription.tier_name as TierName,\n              status: userSubscription.status,\n            } : null}\n            isLoggedIn={!!user}\n          />\n        </div>\n      )}\n\n      {/* Ratings Section */}\n      <div className=\"mb-8\">\n        <StoryRatingSection storyId={id} authorId={story.author_id} />\n      </div>\n\n      {/* Chapter List */}\n      <div className=\"mb-8\">\n        <h2 className=\"text-xl font-semibold mb-4\">\n          Chapters ({publishedChapters.length})\n        </h2>\n        \n        {publishedChapters.length === 0 ? (\n          <Card>\n            <CardContent className=\"py-8 text-center text-muted-foreground\">\n              No chapters published yet. Check back soon!\n            </CardContent>\n          </Card>\n        ) : (\n          <div className=\"space-y-2\">\n            {publishedChapters.map((chapter) => {\n              const isRead = readChapterIds.has(chapter.id);\n              return (\n                <Link\n                  key={chapter.id}\n                  href={`/story/${id}/chapter/${chapter.id}`}\n                  className=\"block\"\n                >\n                  <Card className={`hover:bg-muted/50 transition-colors ${isRead ? \"border-green-500/30 bg-green-500/5\" : \"\"}`}>\n                    <CardContent className=\"py-3 px-4 flex items-center justify-between\">\n                      <div className=\"flex items-center gap-3\">\n                        {isRead && (\n                          <div className=\"flex items-center justify-center w-6 h-6 rounded-full bg-green-500 text-white shrink-0\">\n                            <Check className=\"h-4 w-4\" />\n                          </div>\n                        )}\n                        <div>\n                          <span className=\"font-medium flex items-center gap-1.5\">\n                            Chapter {chapter.chapter_number}: {chapter.title}\n                            {chapter.min_tier_name && (\n                              <Lock className=\"h-3.5 w-3.5 text-amber-500 shrink-0\" />\n                            )}\n                          </span>\n                          <div className=\"flex items-center gap-3 text-sm text-muted-foreground\">\n                            <span>{(chapter.word_count ?? 0).toLocaleString()} words</span>\n                            {(chapter.likes ?? 0) > 0 && (\n                              <span className=\"flex items-center gap-1\">\n                                <Heart className=\"h-3 w-3\" />\n                                {(chapter.likes ?? 0).toLocaleString()}\n                              </span>\n                            )}\n                          </div>\n                        </div>\n                      </div>\n                      <span className=\"text-sm text-muted-foreground\">\n                        {formatDistanceToNow(new Date(chapter.created_at), { addSuffix: true })}\n                      </span>\n                    </CardContent>\n                  </Card>\n                </Link>\n              );\n            })}\n          </div>\n        )}\n      </div>\n\n      {/* More from this Author */}\n      <MoreFromAuthor \n        storyId={id}\n        authorId={story.author_id}\n        authorName={authorName}\n        authorUsername={story.profiles?.username || 'Unknown'}\n      />\n\n      {/* Related Stories */}\n      <RelatedStories \n        storyId={id}\n        genres={story.genres || []}\n        authorId={story.author_id}\n      />\n    </div>\n  );\n\n  if (isMature) {\n    return (\n      <ContentWarningGate warnings={story.content_warnings} storyTitle={story.title}>\n        {pageContent}\n      </ContentWarningGate>\n    );\n  }\n\n  return pageContent;\n}\n",
  "encoding": "base64",
  "downloadUrl": "https://raw.githubusercontent.com/onedollarbanana/FictionForge/feat/social-sharing/src/app/story/%5Bid%5D/page.tsx"
}
