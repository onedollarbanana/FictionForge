{
  "type": "file",
  "name": "page.tsx",
  "path": "src/app/story/[id]/chapter/[chapterId]/page.tsx",
  "size": 16084,
  "sha": "162990c903c951eb6e774e86b2f2d461615a4250",
  "content": "import { createClient } from \"@/lib/supabase/server\";\nimport { notFound } from \"next/navigation\";\nimport Link from \"next/link\";\nimport { TiptapRenderer } from \"@/components/reader/tiptap-renderer\";\nimport { ChapterNav } from \"@/components/reader/chapter-nav\";\nimport { ReadingProgressTracker } from \"@/components/reader/reading-progress-tracker\";\nimport { ViewTracker } from \"@/components/reader/view-tracker\";\nimport { CommentList } from \"@/components/reader/comment-list\";\nimport { ChapterContentWrapper } from \"@/components/reader/chapter-content-wrapper\";\nimport { KeyboardNavigation } from \"@/components/reader/keyboard-navigation\";\nimport { SwipeNavigation } from \"@/components/reader/swipe-navigation\";\nimport { MobileChapterNav } from \"@/components/reader/mobile-chapter-nav\";\nimport { ScrollToTop } from \"@/components/reader/scroll-to-top\";\nimport { AutoLibraryAdd } from \"@/components/reader/auto-library-add\";\nimport { ChapterCompleteCard } from \"@/components/reader/chapter-complete-card\";\nimport { CollapsibleComments } from \"@/components/reader/collapsible-comments\";\nimport { ReadingTimeEstimate, countWordsFromTiptap } from \"@/components/reader/reading-time-estimate\";\nimport { ScrollPositionTracker } from \"@/components/reader/scroll-position-tracker\";\nimport { ChevronLeft } from \"lucide-react\";\nimport { headers } from \"next/headers\";\nimport { ReportButton } from \"@/components/moderation/report-button\";\nimport { ChapterLockedOverlay } from \"@/components/reader/chapter-locked-overlay\";\nimport { type TierName } from \"@/lib/platform-config\";\nimport { ChapterOfflineCacher } from \"@/components/reader/chapter-offline-cacher\";\nimport { ReadingModeSwitch } from \"@/components/reader/reading-mode-switch\";\nimport { PagedModeOnly } from \"@/components/reader/paged-mode-only\";\nimport { ShareButtons } from \"@/components/ui/share-buttons\";\nimport type { Metadata } from \"next\";\n\nexport const revalidate = 120\n\nconst TIER_HIERARCHY: Record<string, number> = {\n  supporter: 1,\n  enthusiast: 2,\n  patron: 3,\n};\n\ninterface PageProps {\n  params: { id: string; chapterId: string };\n}\n\nexport async function generateMetadata({ params }: PageProps): Promise<Metadata> {\n  const { id: storyId, chapterId } = params;\n  const { createClient } = await import(\"@/lib/supabase/server\");\n  const supabase = await createClient();\n\n  const { data: chapter } = await supabase\n    .from(\"chapters\")\n    .select(`\n      title,\n      chapter_number,\n      stories (\n        title,\n        cover_url,\n        genres,\n        profiles!author_id(\n          username,\n          display_name\n        )\n      )\n    `)\n    .eq(\"id\", chapterId)\n    .eq(\"story_id\", storyId)\n    .single();\n\n  if (!chapter || !chapter.stories) {\n    return { title: \"Chapter Not Found | Fictionry\" };\n  }\n\n  const story = chapter.stories as any;\n  const authorName = story.profiles?.display_name || story.profiles?.username || \"Unknown\";\n  const title = `${chapter.title} — ${story.title} | Fictionry`;\n  const description = `Read ${chapter.title} from ${story.title} by ${authorName} on Fictionry`;\n\n  const ogParams = new URLSearchParams();\n  ogParams.set(\"title\", `Ch. ${chapter.chapter_number}: ${chapter.title}`);\n  ogParams.set(\"author\", authorName);\n  if (story.cover_url) ogParams.set(\"cover\", story.cover_url);\n  ogParams.set(\"description\", `From ${story.title}`);\n  if (story.genres && story.genres.length > 0) ogParams.set(\"genre\", story.genres[0]);\n\n  const ogImageUrl = `/api/og?${ogParams.toString()}`;\n\n  return {\n    title,\n    description,\n    openGraph: {\n      title,\n      description,\n      type: \"article\",\n      images: [{ url: ogImageUrl, width: 1200, height: 630 }],\n    },\n    twitter: {\n      card: \"summary_large_image\",\n      title,\n      description,\n      images: [ogImageUrl],\n    },\n  };\n}\n\nexport default async function ChapterReadingPage({ params }: PageProps) {\n  const { id: storyId, chapterId } = params;\n  const supabase = await createClient();\n\n  // Get current user (may be null if not logged in)\n  const { data: { user } } = await supabase.auth.getUser();\n\n  // Fetch chapter with story info (including default author notes)\n  const { data: chapter, error } = await supabase\n    .from(\"chapters\")\n    .select(`\n      *,\n      stories (\n        id,\n        title,\n        author_id,\n        default_author_note_before,\n        default_author_note_after,\n        profiles!author_id(\n          username\n        )\n      )\n    `)\n    .eq(\"id\", chapterId)\n    .eq(\"story_id\", storyId)\n    .single();\n\n  if (error || !chapter) {\n    notFound();\n  }\n\n  // Only show published chapters (unless author)\n  if (!chapter.is_published && chapter.stories?.author_id !== user?.id) {\n    notFound();\n  }\n\n  // Fetch author tiers for gating check\n  const { data: authorTiers } = await supabase\n    .from('author_tiers')\n    .select('tier_name, enabled, description')\n    .eq('author_id', chapter.stories?.author_id)\n    .eq('enabled', true);\n\n  // Check if chapter is gated and user has access\n  let hasAccess = true;\n  const requiredTier = chapter.min_tier_name;\n\n  if (requiredTier && chapter.stories?.author_id !== user?.id) {\n    hasAccess = false;\n\n    if (user) {\n      // Check if user has an active subscription to this author at required tier or higher\n      const { data: sub } = await supabase\n        .from('author_subscriptions')\n        .select('tier_name')\n        .eq('subscriber_id', user.id)\n        .eq('author_id', chapter.stories?.author_id)\n        .eq('status', 'active')\n        .single();\n\n      if (sub && TIER_HIERARCHY[sub.tier_name] >= TIER_HIERARCHY[requiredTier]) {\n        hasAccess = true;\n      }\n    }\n  }\n\n  // Fetch all chapters for navigation\n  const { data: allChapters } = await supabase\n    .from(\"chapters\")\n    .select(\"id, title, chapter_number, is_published\")\n    .eq(\"story_id\", storyId)\n    .eq(\"is_published\", true)\n    .order(\"chapter_number\", { ascending: true });\n\n  const chapters = allChapters || [];\n  const currentIndex = chapters.findIndex((ch) => ch.id === chapterId);\n  const prevChapter = currentIndex > 0 ? chapters[currentIndex - 1] : null;\n  const nextChapter = currentIndex < chapters.length - 1 ? chapters[currentIndex + 1] : null;\n\n  // Calculate word count for reading time\n  const wordCount = countWordsFromTiptap(chapter.content);\n\n  // Get the current URL for sharing\n  const headersList = await headers();\n  const host = headersList.get('host') || 'fiction-forge-mu.vercel.app';\n  const protocol = host.includes('localhost') ? 'http' : 'https';\n  const storyUrl = `${protocol}://${host}/story/${storyId}`;\n\n  // Header content for the wrapper\n  const headerContent = (\n    <>\n      <Link\n        href={`/story/${storyId}`}\n        className=\"flex items-center gap-1 text-sm opacity-70 hover:opacity-100\"\n      >\n        <ChevronLeft className=\"h-4 w-4\" />\n        <span className=\"truncate max-w-[200px]\">{chapter.stories?.title}</span>\n      </Link>\n      <div className=\"flex items-center gap-3\">\n        <span className=\"text-sm font-medium\">Chapter {chapter.chapter_number}</span>\n        <ReadingTimeEstimate wordCount={wordCount} />\n      </div>\n    </>\n  );\n\n  return (\n    <>\n      {/* Scroll to top on navigation — disabled in continuous scroll mode */}\n      <PagedModeOnly>\n        <ScrollToTop />\n      </PagedModeOnly>\n\n      {/* Cache chapter for offline reading */}\n      <ChapterOfflineCacher\n        storyId={storyId}\n        chapterId={chapterId}\n        storyTitle={chapter.stories?.title || ''}\n        chapterTitle={chapter.title}\n        chapterNumber={chapter.chapter_number}\n        authorName={chapter.stories?.profiles?.username || 'Unknown'}\n        content={chapter.content}\n        wordCount={wordCount}\n        prevChapterId={prevChapter?.id}\n        nextChapterId={nextChapter?.id}\n      />\n\n      {/* Auto-add to library when reading chapter 2+ */}\n      <AutoLibraryAdd \n        storyId={storyId} \n        chapterNumber={chapter.chapter_number} \n      />\n\n      {/* Track reading progress */}\n      <ReadingProgressTracker\n        storyId={storyId}\n        chapterId={chapterId}\n        chapterNumber={chapter.chapter_number}\n        userId={user?.id ?? null}\n      />\n\n      {/* Track scroll position for resume reading */}\n      <ScrollPositionTracker\n        storyId={storyId}\n        chapterId={chapterId}\n        chapterNumber={chapter.chapter_number}\n        userId={user?.id ?? null}\n      />\n\n      {/* Track views (unique per session/user) */}\n      <ViewTracker chapterId={chapterId} storyId={storyId} />\n\n      {/* Keyboard/swipe navigation: disabled in continuous scroll mode */}\n      <PagedModeOnly>\n        <KeyboardNavigation\n          storyId={storyId}\n          prevChapterId={prevChapter?.id}\n          nextChapterId={nextChapter?.id}\n        />\n        <SwipeNavigation\n          storyId={storyId}\n          prevChapterId={prevChapter?.id}\n          nextChapterId={nextChapter?.id}\n        />\n      </PagedModeOnly>\n\n      <ChapterContentWrapper \n        headerContent={headerContent}\n        storyTitle={chapter.stories?.title || 'Fictionry'}\n        storyUrl={storyUrl}\n      >\n        <header className=\"mb-8\">\n          <h1 className=\"text-2xl md:text-3xl font-bold\">{chapter.title}</h1>\n          <div className=\"flex items-center gap-3 mt-2\">\n            <p className=\"opacity-70\">\n              By{\" \"}\n              <Link\n                href={`/author/${chapter.stories?.profiles?.username}`}\n                className=\"hover:underline\"\n              >\n                {chapter.stories?.profiles?.username || \"Unknown\"}\n              </Link>\n            </p>\n            <ReadingTimeEstimate wordCount={wordCount} variant=\"full\" />\n            <ShareButtons\n              url={`https://fictionry.com/story/${storyId}/chapter/${chapterId}`}\n              title={`${chapter.title} — ${chapter.stories?.title || \"Story\"}`}\n              description={`Read ${chapter.title} from ${chapter.stories?.title || \"a story\"} on Fictionry`}\n            />\n          </div>\n        </header>\n\n        {!hasAccess ? (\n          <ChapterLockedOverlay\n            storyId={storyId}\n            authorId={chapter.stories?.author_id || ''}\n            authorName={chapter.stories?.profiles?.username || 'this author'}\n            requiredTier={requiredTier as TierName}\n            availableTiers={(authorTiers || []).map(t => ({\n              tier_name: t.tier_name as TierName,\n              enabled: t.enabled,\n              description: t.description,\n            }))}\n            isLoggedIn={!!user}\n          />\n        ) : (\n          <>\n            {/* Story Default Author's Note (Before) */}\n            {chapter.stories?.default_author_note_before && (\n              <div className=\"mb-6 p-4 rounded-lg bg-black/5 dark:bg-white/5 border-l-4 border-primary\">\n                <p className=\"text-sm font-medium opacity-70 mb-1\">Author&apos;s Note</p>\n                <p className=\"text-sm whitespace-pre-wrap break-words\">{chapter.stories.default_author_note_before}</p>\n              </div>\n            )}\n\n            {/* Chapter-Specific Author's Note (Before) */}\n            {chapter.author_note_before && (\n              <div className=\"mb-8 p-4 rounded-lg bg-black/5 dark:bg-white/5 border-l-4 border-secondary\">\n                <p className=\"text-sm font-medium opacity-70 mb-1\">Chapter Note</p>\n                <p className=\"text-sm whitespace-pre-wrap break-words\">{chapter.author_note_before}</p>\n              </div>\n            )}\n\n            {/* Main Content */}\n            <div className=\"prose dark:prose-invert max-w-none\">\n              <TiptapRenderer content={chapter.content} />\n            </div>\n\n            {/* Chapter-Specific Author's Note (After) */}\n            {chapter.author_note_after && (\n              <div className=\"mt-8 p-4 rounded-lg bg-black/5 dark:bg-white/5 border-l-4 border-secondary\">\n                <p className=\"text-sm font-medium opacity-70 mb-1\">Chapter Note</p>\n                <p className=\"text-sm whitespace-pre-wrap break-words\">{chapter.author_note_after}</p>\n              </div>\n            )}\n\n            {/* Story Default Author's Note (After) */}\n            {chapter.stories?.default_author_note_after && (\n              <div className=\"mt-6 p-4 rounded-lg bg-black/5 dark:bg-white/5 border-l-4 border-primary\">\n                <p className=\"text-sm font-medium opacity-70 mb-1\">Author&apos;s Note</p>\n                <p className=\"text-sm whitespace-pre-wrap break-words\">{chapter.stories.default_author_note_after}</p>\n              </div>\n            )}\n          </>\n        )}\n\n        {/* Post-content: different rendering based on reading mode */}\n        <ReadingModeSwitch\n          pagedContent={\n            <>\n              <ChapterCompleteCard\n                storyId={storyId}\n                storyTitle={chapter.stories?.title ?? \"\"}\n                chapterId={chapterId}\n                chapterNumber={chapter.chapter_number}\n                chapterTitle={chapter.title}\n                totalChapters={chapters.length}\n                initialLikes={chapter.likes ?? 0}\n                currentUserId={user?.id ?? null}\n                storyAuthorId={chapter.stories?.author_id ?? \"\"}\n                prevChapter={prevChapter ? { id: prevChapter.id, title: prevChapter.title } : null}\n                nextChapter={nextChapter ? { id: nextChapter.id, title: nextChapter.title } : null}\n                reportButton={\n                  user && user.id !== chapter.stories?.author_id ? (\n                    <ReportButton\n                      contentType=\"chapter\"\n                      contentId={chapterId}\n                      contentTitle={`${chapter.stories?.title} - Ch. ${chapter.chapter_number}: ${chapter.title}`}\n                      size=\"sm\"\n                      variant=\"ghost\"\n                    />\n                  ) : undefined\n                }\n              />\n\n              {/* Chapter Navigation - Hidden on mobile (bottom nav shows instead) */}\n              <div className=\"hidden md:block\">\n                <ChapterNav\n                  storyId={storyId}\n                  currentChapter={chapter.chapter_number}\n                  totalChapters={chapters.length}\n                  prevChapterId={prevChapter?.id}\n                  nextChapterId={nextChapter?.id}\n                />\n              </div>\n\n              {/* Comments - collapsed on mobile for binge readers */}\n              <CollapsibleComments>\n                <CommentList\n                  chapterId={chapterId}\n                  currentUserId={user?.id ?? null}\n                  storyAuthorId={chapter.stories?.author_id ?? \"\"}\n                />\n              </CollapsibleComments>\n            </>\n          }\n          continuousScrollData={{\n            initialChapterId: chapterId,\n            initialChapterTitle: chapter.title,\n            initialChapterNumber: chapter.chapter_number,\n            initialWordCount: wordCount,\n            initialCommentCount: 0,\n            allChapterIds: chapters.map(ch => ({ id: ch.id, title: ch.title, chapterNumber: ch.chapter_number })),\n            storyId,\n            storyTitle: chapter.stories?.title || '',\n            currentUserId: user?.id ?? null,\n            storyAuthorId: chapter.stories?.author_id ?? '',\n            authorName: (chapter.stories?.profiles as any)?.username || 'Unknown',\n            authorTiers: (authorTiers || []).map(t => ({\n              tier_name: t.tier_name,\n              enabled: t.enabled,\n              description: t.description,\n            })),\n          }}\n        />\n\n        {/* Mobile Bottom Navigation - always visible for jump-to-chapter */}\n        <MobileChapterNav\n          storyId={storyId}\n          storyTitle={chapter.stories?.title ?? \"\"}\n          prevChapter={prevChapter ? { id: prevChapter.id, title: prevChapter.title } : null}\n          nextChapter={nextChapter ? { id: nextChapter.id, title: nextChapter.title } : null}\n          currentChapterNumber={chapter.chapter_number}\n          totalChapters={chapters.length}\n        />\n      </ChapterContentWrapper>\n    </>\n  );\n}\n",
  "encoding": "base64",
  "downloadUrl": "https://raw.githubusercontent.com/onedollarbanana/FictionForge/feat/social-sharing/src/app/story/%5Bid%5D/chapter/%5BchapterId%5D/page.tsx"
}
